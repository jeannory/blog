<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Jeannory&#39;s blog">
		<link rel="icon" href="https://jeannory.github.io/blog/favicon.ico">
		<title>Gitlab - Jeannory&#39;s blog</title>
		
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/highlight/default.css">
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/theme.css">
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/bootie-docs.css">
		<link rel="stylesheet" href="https://jeannory.github.io/blog/css/site.css">
	</head>

<body role="document">

	
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://jeannory.github.io/blog/">Jeannory&#39;s blog</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li ><a href="https://jeannory.github.io/blog/author">Author</a></li>
			
			
				
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Categories<span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
						
							<li><a href="https://jeannory.github.io/blog/categories/gitlab">Gitlab</a></li>
						
							<li><a href="https://jeannory.github.io/blog/categories/keycloak">Keycloak</a></li>
						
							<li><a href="https://jeannory.github.io/blog/categories/spring-security">Spring-Security</a></li>
						
							<li><a href="https://jeannory.github.io/blog/categories/springboot-tests">Springboot-Tests</a></li>
						
						</ul>
					</li>
				
				</ul>
				
			</div>
		</div>
	</nav>

<div class="container">


<div class="row">
	<div class="col-sm-8 doc-main">
		<main role="main">
			<article>
				<a id="title"></a>
				<h1 class="doc-entry-title">Gitlab</h1>
				<div class="doc-entry-meta">
					<span><time datetime="2020-04-26">April 26, 2020</time></span>
				</div>
				<section>
					

<h2 id="introduction">Introduction</h2>

<p>Gitlab fournit un ensemble de service complet pour l&rsquo;intégration et le déploiement continue.
Exemple d&rsquo;utilisation avec le projet Back-end de <a href="/blog/articles/keycloak/">Keycloak</a>.</p>

<h3 id="dépôts-gitlab">Dépôts Gitlab</h3>

<ul>
<li><a href="https://gitlab.com/phou.jeannory/keycloak-back-end.git">Back-end</a></li>
<li><a href="https://gitlab.com/phou.jeannory/keycloak-front-end.git">Front-end</a></li>
</ul>

<h2 id="gitlab-ci">Gitlab-CI</h2>

<p>A chaque commit, Gitlab va lancer les tâches (stages) à partir du fichier .gitlab-ci.yml enregistré à la racine du projet.</p>

<h3 id="build-du-projet">Build du projet</h3>

<p>L&rsquo;image maven:3.3.9-jdk-8 sera utilisé dans différents stages.
Gitlab va mettre en cache les dépendances maven et le contenu du target ce qui va engendrer un gain de temps, ressources et de connexion.</p>

<pre><code>image: maven:3.3.9-jdk-8

variables:
    MAVEN_CLI_OPTS: &quot;--batch-mode --errors --fail-at-end --show-version&quot;
    MAVEN_OPTS: &quot;-Dmaven.repo.local=${CI_PROJECT_DIR}/.m2&quot;

cache:
    key: ${CI_COMMIT_REF_SLUG} # cache is for per branch
    paths:
        - ${CI_PROJECT_DIR}/.m2
        - target/

stages:
    - build

build_job:
    stage: build
    script:
        - 'mvn $MAVEN_CLI_OPTS package -Pdev -DskipTests'
    only:
        - dev-docker
</code></pre>

<p>Au prochain commit sur la branche dev-docker, les dépendances et le build du projet ont bien été mis dans le cache.</p>

<pre><code>Running after_script
00:02
Saving cache
00:14
Creating cache dev-docker...
/builds/phou.jeannory/keycloak-back-end/.m2: found 3366 matching files 
target/: found 200 matching files                  
Uploading cache.zip to https://storage.googleapis.com/gitlab-com-runners-cache/project/18369362/dev-docker 
Created cache
Uploading artifacts for successful job
00:01
Job succeeded
</code></pre>

<h3 id="les-tests-unitaires">Les tests unitaires</h3>

<p>Lancement des tests unitaires en utilisant le profile dev-docker</p>

<pre><code>&lt;profile&gt;
    &lt;id&gt;dev-docker&lt;/id&gt;
    &lt;activation&gt;
        &lt;activeByDefault&gt;false&lt;/activeByDefault&gt;
    &lt;/activation&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;!-- exclude integration tests--&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.0.0-M1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;excludes&gt;
                        &lt;exclude&gt;**/KeycloakApplicationTests*.java&lt;/exclude&gt;
                        &lt;exclude&gt;**/UserControllerContextTest*.java&lt;/exclude&gt;
                        &lt;exclude&gt;**/SpaceControllerContextTest*.java&lt;/exclude&gt;
                    &lt;/excludes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;
</code></pre>

<hr />

<pre><code>junit-tests:
    stage: junit-tests
    script:
        - 'mvn $MAVEN_CLI_OPTS test -Pdev-docker'
    only:
        - dev-docker
</code></pre>

<p>Les logs affichent une opération réussis</p>

<pre><code>[INFO] Results:
[INFO] 
[INFO] Tests run: 20, Failures: 0, Errors: 0, Skipped: 0
</code></pre>

<h3 id="affichage-de-couverture-de-code">Affichage de couverture de code</h3>

<p>Utilisation du pluglin jacoco pour afficher le coverage dans Gitlab</p>

<pre><code>&lt;plugin&gt;
    &lt;groupId&gt;org.jacoco&lt;/groupId&gt;
    &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;0.8.5&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;prepare-agent&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
        &lt;!-- attached to Maven test phase --&gt;
        &lt;execution&gt;
            &lt;id&gt;report&lt;/id&gt;
            &lt;phase&gt;test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;report&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<p>Récupération du site static généré par jacoco dans le target pour l&rsquo;afficher dans le répertoire junit-tests de Gitlab</p>

<pre><code>junit-tests-coverage:
    stage: junit-tests-coverage
    script:
        - mkdir public
        - mv target/site/* junit-tests
    artifacts:
        paths:
        - junit-tests
    only:
        - dev-docker
</code></pre>

<p>Affichage du rapport : cliquez sur Browse et naviguez jusqu&rsquo;à index.html</p>

<p><img src="/blog/img/gitlab-02.png" alt="chemin" /></p>

<p>Les différents coverages sont détaillés dans un dashboard.</p>

<p><img src="/blog/img/gitlab-03.png" alt="rapport tests unitaires" /></p>

<h3 id="qualité-du-code">Qualité du code</h3>

<p>La qualité du code, une aide non négligeable pour tous développeur.</p>

<pre><code>code_quality_job:
    stage: quality
    image: docker:stable
    allow_failure: true
    services:
        - docker:stable-dind
    script:
        - mkdir codequality-results
        - docker run
        --env CODECLIMATE_CODE=&quot;$PWD&quot;
        --volume &quot;$PWD&quot;:/code
        --volume /var/run/docker.sock:/var/run/docker.sock
        --volume /tmp/cc:/tmp/cc
        codeclimate/codeclimate analyze -f html &gt; ./codequality-results/index.html
    artifacts:
        paths:
        - codequality-results/
    only:
        - dev-docker
</code></pre>

<p>Affichage du rapport</p>

<p><img src="/blog/img/gitlab-04.png" alt="rapport qualité de code" /></p>

<h3 id="les-tests-d-intégration">Les tests d&rsquo;intégration</h3>

<p>Pour les tests d&rsquo;intégration, il est nécessaire de se connecter à un serveur. Pour cela nous allons utiliser une clef privée.
Ouvrir le menu Settings/CI/CD/Variables et enregistrer la clef</p>

<p><img src="/blog/img/gitlab-01.png" alt="private key" /></p>

<p>Pour les tests gitlab va ouvrir le port du serveur postgresql, puis le refermer. Il s&rsquo;agit d&rsquo;une solution provisoire en attendant de créer un tunnel ssh&hellip;</p>

<pre><code>enable-remote-bdd:
    stage: enable-remote-bdd
    image: ubuntu:latest
    before_script:
        - 'which ssh-agent || ( apt-get update -y &amp;&amp; apt-get install openssh-client -y)'
        - mkdir -p ~/.ssh
        - echo &quot;$SSH_PRIVATE_KEY&quot; | tr -d '\r' &gt; ~/.ssh/id_rsa
        - chmod 700 ~/.ssh/id_rsa
        - eval &quot;$(ssh-agent -s)&quot;
        - ssh-add ~/.ssh/id_rsa
        - '[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt; ~/.ssh/config'
    script:
        - ssh-copy-id digital@$X230_SERVER_1 -p &quot;18380&quot;
        - ssh -t digital@$X230_SERVER_1 -p &quot;18380&quot; &lt;&lt; END
        - pwd
        - exec 3&gt;&amp;1 1&gt;/dev/null 2&gt;&amp;1
        - echo &quot;$X230_PASSWORD_1&quot; | sudo -S ufw allow 5432
        - sudo -S ufw status &gt;&amp;3
        - END
    only:
        - dev-docker
</code></pre>

<p>Les tests d&rsquo;intégration nécessitent une connexion vers base de données et vers le serveur d&rsquo;authentification Keycloak (utilisation du profil maven dev-docker-integration-testing et du profil Springboot dev-docker-integration-testing)</p>

<pre><code>integration-tests:
    stage: integration-tests
    script:
        - 'mvn $MAVEN_CLI_OPTS clean verify -Pdev-docker-integration-testing -Dspring.profiles.active=dev-docker-integration-testing'
    only:
        - dev-docker
</code></pre>

<p>pom.xml</p>

<pre><code>&lt;profile&gt;
    &lt;id&gt;dev-docker-integration-testing&lt;/id&gt;
    &lt;activation&gt;
        &lt;activeByDefault&gt;false&lt;/activeByDefault&gt;
    &lt;/activation&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;!-- only integration tests--&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.0.0-M1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;excludes&gt;
                        &lt;exclude&gt;**/SpaceSpaceDtoConverterTest*.java&lt;/exclude&gt;
                        &lt;exclude&gt;**/UserUserDtoConverterTest*.java&lt;/exclude&gt;
                        &lt;exclude&gt;**/UserServiceImplTest*.java&lt;/exclude&gt;
                        &lt;exclude&gt;**/UserServiceImplTest*.java&lt;/exclude&gt;
                    &lt;/excludes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;
</code></pre>

<p>fichier application.yml</p>

<pre><code>spring:
    profiles: dev-docker-integration-testing

    jpa:
        database: POSTGRESQL
        show-sql: true
        hibernate:
        ddl-auto: create-drop

    datasource:
        platform: postgres
        url: jdbc:postgresql://jeannory.dynamic-dns.net:5432/keycloak_back_end_db
        username: user1
</code></pre>

<p>Résultat des tests</p>

<pre><code>[INFO] Results:
[INFO] 
[INFO] Tests run: 7, Failures: 0, Errors: 0, Skipped: 0
</code></pre>

<p>Affichage du rapport</p>

<p><img src="/blog/img/gitlab-05.png" alt="rapport tests d'intégration" /></p>

<h2 id="gitlab-cd">Gitlab-CD</h2>

<p>toDo</p>

<h3 id="build-de-l-application-back-end">Build de l&rsquo;application back-end</h3>

<p>toDo</p>

<h3 id="déploiement-de-l-application-back-end">Déploiement de l&rsquo;application back-end</h3>

<p>toDo</p>

				</section>
			</article>
		</main>
	</div> 

	

<div class="col-sm-3 col-sm-offset-1 doc-sidebar">
	<div id="sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4 class="sidebar-heading">Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">Gitlab</a></strong></li>
			</ul>
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#dépôts-gitlab">Dépôts Gitlab</a></li>
</ul></li>
<li><a href="#gitlab-ci">Gitlab-CI</a>
<ul>
<li><a href="#build-du-projet">Build du projet</a></li>
<li><a href="#les-tests-unitaires">Les tests unitaires</a></li>
<li><a href="#affichage-de-couverture-de-code">Affichage de couverture de code</a></li>
<li><a href="#qualité-du-code">Qualité du code</a></li>
<li><a href="#les-tests-d-intégration">Les tests d&rsquo;intégration</a></li>
</ul></li>
<li><a href="#gitlab-cd">Gitlab-CD</a>
<ul>
<li><a href="#build-de-l-application-back-end">Build de l&rsquo;application back-end</a></li>
<li><a href="#déploiement-de-l-application-back-end">Déploiement de l&rsquo;application back-end</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		</div>
	</div>
	<div class="sidebar-module">
		<h4 class="sidebar-heading">Pages in Categories</h4>
		<ul class="sidebar-category-list">
		
			<li>
				<a href="https://jeannory.github.io/blog/categories/gitlab">
					<span class="doc-list-category">Gitlab</span>
				</a>
				<ul>
					<li>
						<span class="active">Gitlab</span>
						</li>
				
				</ul>
			</li>
		
			<li>
				<a href="https://jeannory.github.io/blog/categories/keycloak">
					<span class="doc-list-category">Keycloak</span>
				</a>
				<ul>
					<li><a href="/blog/articles/keycloak/">Keycloak</a>
					</li>
				
				</ul>
			</li>
		
			<li>
				<a href="https://jeannory.github.io/blog/categories/spring-security">
					<span class="doc-list-category">Spring-Security</span>
				</a>
				<ul>
					<li><a href="/blog/articles/spring-security/">Spring Security</a>
					</li>
				
				</ul>
			</li>
		
			<li>
				<a href="https://jeannory.github.io/blog/categories/springboot-tests">
					<span class="doc-list-category">Springboot-Tests</span>
				</a>
				<ul>
					<li><a href="/blog/articles/springboot-tests/">Springboot-tests</a>
					</li>
				
				</ul>
			</li>
		
		</ul>
	</div>
	<div class="sidebar-module">
		<h4 class="sidebar-heading">Tags</h4>
		<div class="tag-box">
		
			<a class="tag-item" href="https://jeannory.github.io/blog/tags/articles">articles</a>
		
			<a class="tag-item" href="https://jeannory.github.io/blog/tags/author">author</a>
		
		</div>
	</div>
	</div>
</div>

</div> 


<hr />

<div class="row">
	<div class="col-sm-8">
		<p class="doc-footer-em"><a href="#" onclick="resetSidebarPos()">Back to TOP</a></p>
	</div>
</div>

</div> 

<footer class="doc-footer">
	
	
	<p>Powered by <strong><a href="https://github.com/progrhyme/hugo-theme-bootie-docs">Bootie Docs</a></strong> - theme for <a href="http://gohugo.io/">Hugo</a> by <a href="https://github.com/progrhyme/">progrhyme</a>.</p>
</footer>



<script src="https://jeannory.github.io/blog/js/jquery.min.js"></script>
<script src="https://jeannory.github.io/blog/js/bootstrap.min.js"></script>

<script src="https://jeannory.github.io/blog/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://jeannory.github.io/blog/js/ie10-viewport-bug-workaround.js"></script>
<script src="https://jeannory.github.io/blog/js/bootie-docs.js"></script>

</body>
</html>
